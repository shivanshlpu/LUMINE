<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumine | Somnath Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Laila:wght@500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            /* Lumine Design Tokens */
            --primary: #d97706;       /* Saffron */
            --primary-dark: #b45309;
            --primary-light: #fff7ed;
            --navy: #012a4a;          /* Official Navy */
            --navy-light: #023e6b;
            --bg-body: #fffdfa;       /* Cream Background */
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --red: #ef4444;
            --green: #10b981;
            
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border: 1px solid #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- 1. Header --- */
        .top-header {
            background: var(--white);
            height: 70px;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            flex-shrink: 0;
            z-index: 100;
        }

        .brand-area { display: flex; align-items: center; gap: 12px; }
        .brand-icon {
            width: 36px; height: 36px;
            background: var(--primary);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px;
        }
        .brand-text h2 { font-family: 'Laila', serif; font-size: 1.2rem; line-height: 1; color: var(--navy); }
        .brand-text span { font-size: 0.7rem; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; }

        .nav-pills { display: flex; gap: 10px; }
        
        .nav-pill {
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 500; 
            cursor: pointer; 
            color: var(--text-muted); 
            transition: 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .nav-pill.active { background: var(--primary); color: white; }
        .nav-pill:hover:not(.active) { background: var(--primary-light); color: var(--primary-dark); }

        /* Logout Button Style */
        .logout-btn {
            margin-left: 15px;
            padding: 8px 16px;
            background: #fee2e2;
            color: var(--red);
            border: 1px solid #fecaca;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }

        /* --- 2. Stats Bar --- */
        .stats-bar {
            padding: 20px 30px 10px 30px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            flex-shrink: 0;
        }

        .stat-card {
            background: var(--white);
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: var(--border);
        }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--navy); margin-top: 5px; font-family: 'Laila', serif; }

        /* --- 3. Main Layout Grid --- */
        .main-layout {
            flex-grow: 1;
            padding: 10px 30px 20px 30px;
            display: grid;
            grid-template-columns: 1.2fr 1.2fr 320px;
            gap: 20px;
            overflow: hidden;
        }

        /* Common Panel Styling */
        .panel {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-head {
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-title { font-weight: 600; color: var(--navy); font-size: 0.9rem; }
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .badge-live { background: #fee2e2; color: var(--red); animation: blink 2s infinite; }

        /* Section A: Heatmap */
        .left-col { height: 100%; }
        #heatmap-container { flex-grow: 1; width: 100%; height: 100%; background: #e5e7eb; }

        /* Section B: Alerts & Lanes */
        .center-col { display: flex; flex-direction: column; gap: 20px; height: 100%; }
        
        /* Alert Map */
        .alert-map-panel { flex: 2; position: relative; }
        #alertmap-container { width: 100%; height: 100%; background: #e5e7eb; }

        /* Leaflet Customization for Lumine Theme */
        .leaflet-control-zoom a, .leaflet-control-layers-toggle {
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            color: var(--navy) !important;
            border: 1px solid #e2e8f0 !important;
        }
        .leaflet-bar { border: none !important; box-shadow: none !important; }
        .leaflet-touch .leaflet-control-layers, .leaflet-touch .leaflet-bar {
            border: none !important;
        }
        .leaflet-control-layers {
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            border: 1px solid #e2e8f0 !important;
            font-family: 'Poppins', sans-serif !important;
            font-size: 0.8rem !important;
        }

        /* Alert Detail Float */
        .alert-float-panel {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        .alert-float-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .btn-assign {
            width: 100%; padding: 10px; background: var(--navy); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-assign:hover { background: var(--navy-light); }

        /* Lane Control */
        .lane-panel { flex: 1; display: flex; flex-direction: column; }
        .lane-grid {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            flex-grow: 1;
        }
        .lane-btn {
            background: white; border: 1px solid #cbd5e1; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .lane-btn h5 { font-size: 0.9rem; color: var(--navy); margin-bottom: 2px; }
        .lane-btn span { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; }
        
        .lane-btn.busy { background: var(--primary); border-color: var(--primary-dark); }
        .lane-btn.busy h5, .lane-btn.busy span { color: white; }
        .lane-btn.closed { background: var(--text-dark); border-color: black; }
        .lane-btn.closed h5, .lane-btn.closed span { color: white; }

        /* Section C: Right Sidebar (Guards) */
        .guard-list { padding: 0; overflow-y: auto; flex-grow: 1; }
        .guard-card {
            padding: 15px; border-bottom: var(--border); transition: 0.2s;
        }
        .guard-card.highlight { background: #fff7ed; border-left: 4px solid var(--primary); }
        .guard-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* Map Markers */
        .pulse-marker {
            width: 30px; height: 30px;
            background: white; border: 2px solid var(--red); border-radius: 50%;
            color: var(--red); display: flex; justify-content: center; align-items: center;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .toast {
            position: fixed; top: 80px; right: 30px;
            background: var(--navy); color: white; padding: 12px 20px;
            border-radius: 8px; border-left: 4px solid var(--green);
            transform: translateX(200%); transition: 0.3s; z-index: 2000;
        }

    </style>
</head>
<body>

    <header class="top-header">
        <div class="brand-area">
            <div class="brand-icon">üèõÔ∏è</div>
            <div class="brand-text">
                <h2>Lumine</h2>
                <span>Somnath Mandir</span>
            </div>
        </div>
        
        <div class="nav-pills">
            <a href="dashboard.html" class="nav-pill active">Dashboard</a>
            <a href="heatmap.html" class="nav-pill">Live Heatmap</a>
            <a href="guard.html" class="nav-pill">Guard Teams</a>
            <a href="lane.html" class="nav-pill">Lane Control</a>
            <a href="#" class="nav-pill">Settings</a>
        </div>
        
        <div style="display: flex; align-items: center;">
            <div style="width:35px; height:35px; background:var(--primary-light); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary); font-weight:bold;">A</div>
            <button onclick="logout()" class="logout-btn">Logout ‚Ü™</button>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Live Head Count</div>
            <div class="stat-val">12,450</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">App Registered</div>
            <div class="stat-val">4,102</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Window Users</div>
            <div class="stat-val">842</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Alerts Active</div>
            <div class="stat-val" style="color:var(--red)">03</div>
        </div>
    </div>

    <main class="main-layout">
        
        <div class="panel left-col">
            <div class="panel-head">
                <span class="panel-title">Real-Time Heatmap View</span>
                <span class="badge badge-live">LIVE FEED</span>
            </div>
            <div id="heatmap-container"></div>
        </div>

        <div class="center-col">
            
            <div class="panel alert-map-panel">
                <div class="panel-head">
                    <span class="panel-title">SOS & Alerts Map View</span>
                    <span class="badge" style="background:var(--navy); color:white;">INTERACTIVE</span>
                </div>
                <div id="alertmap-container"></div>

                <div class="alert-float-panel" id="alert-panel">
                    <div class="alert-float-header">
                        <div>
                            <h4 style="color:var(--red); margin-bottom:2px;" id="alert-title">Medical Emergency</h4>
                            <small style="color:var(--text-muted);" id="alert-loc">Near Gate 2 ‚Ä¢ 2m ago</small>
                        </div>
                        <button onclick="closeAlert()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                    </div>
                    <div style="font-size:0.8rem; margin-bottom:10px; color:var(--text-dark);">
                        <strong>Details:</strong> <span id="alert-desc">User reported heatstroke symptoms via App.</span>
                    </div>
                    <button class="btn-assign" onclick="assignNearestGuard()">
                        üëÆ Assign Nearest Guard Team
                    </button>
                </div>
            </div>

            <div class="panel lane-panel">
                <div class="panel-head">
                    <span class="panel-title">Lane Control (Public View)</span>
                </div>
                <div class="lane-grid" id="lane-grid">
                </div>
            </div>
        </div>

        <div class="panel right-col">
            <div class="panel-head">
                <span class="panel-title">Deployed Teams</span>
                <span style="color:var(--primary); font-size:0.8rem; cursor:pointer;">+ Add Team</span>
            </div>
            <div class="guard-list" id="guard-list">
            </div>
        </div>

    </main>

    <div class="toast" id="toast">‚úÖ Team Alpha Assigned Successfully</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        // --- CONFIGURATION ---
        const CENTER_COORDS = [20.8881, 70.4012]; 
        let activeAlertId = null;

        // Mock Data
        const guards = [
            { id: 'g1', name: 'Team Alpha', status: 'Available', lat: 20.8885, lon: 70.4005, dist: 'Calculating...' },
            { id: 'g2', name: 'Team Beta', status: 'Busy', lat: 20.8870, lon: 70.4020, dist: 'Calculating...' },
            { id: 'g3', name: 'Team Gamma', status: 'Available', lat: 20.8890, lon: 70.4015, dist: 'Calculating...' },
        ];

        const alerts = [
            { id: 1, type: 'Crowd High Density', icon: 'üë•', loc: 'Gate 2', lat: 20.8882, lon: 70.4008, desc: 'Camera #42 detected > 100 people queue.' },
            { id: 2, type: 'Medical Assistance', icon: 'üöë', loc: 'Queue Complex', lat: 20.8875, lon: 70.4012, desc: 'Devotee SOS: Fainting reported.' },
            { id: 3, type: 'Lost Child', icon: 'üë∂', loc: 'Shoe Counter', lat: 20.8888, lon: 70.4002, desc: 'Blue shirt, 5 years old.' }
        ];

        // --- TILE LAYERS DEFINITION ---
        
        // 1. Alert Map Layers (Standard)
        const mapStyleNormal = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
            attribution: 'Lumine', maxZoom: 21 
        });
        const mapStyleSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 21 
        });

        // 2. Heatmap Layers (Cleaner)
        // Voyager "NoLabels" is better for heatmaps so text doesn't overlap
        const heatMapStyleClean = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', { 
            attribution: 'Lumine', maxZoom: 21 
        });
        const heatMapStyleSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 21 
        });

        // --- MAP 1: HEATMAP (Left) ---
        const heatMap = L.map('heatmap-container', { 
            zoomControl: true, 
            layers: [heatMapStyleClean] // Default to clean view
        }).setView(CENTER_COORDS, 20);
        
        // Add Layer Control to Heatmap
        const heatmapLayers = {
            "Clean Map": heatMapStyleClean,
            "Satellite": heatMapStyleSat
        };
        L.control.layers(heatmapLayers, null, { position: 'topright' }).addTo(heatMap);
        
        // --- HEATMAP LOGIC ---
        const generateLaneFeature = (index) => {
            const latBase = 20.8883 - (index * 0.00006); 
            const lngStart = 70.4016; 
            const lngEnd = 70.4008;   
            return { 
                "properties": { 
                    "id": `L0${index + 1}`, "capacity": 300, 
                    "current": 50 + Math.floor(Math.random() * 50) 
                }, 
                "geometry": { 
                    "coordinates": [[
                        [lngStart, latBase], [lngEnd, latBase], 
                        [lngEnd, latBase - 0.00004], [lngStart, latBase - 0.00004], 
                        [lngStart, latBase]
                    ]] 
                } 
            };
        };

        const lanesData = Array.from({ length: 8 }, (_, i) => generateLaneFeature(i));
        lanesData[1].properties.current = 280; 
        lanesData[2].properties.current = 295;

        const generateLaneBasedPoints = () => {
            const points = [];
            const AGGREGATION_FACTOR = 20; 
            lanesData.forEach(lane => {
                const totalPeople = lane.properties.current;
                const dotsToShow = Math.ceil(totalPeople / AGGREGATION_FACTOR);
                const coords = lane.geometry.coordinates[0];
                const minLng = Math.min(coords[0][0], coords[1][0]);
                const maxLng = Math.max(coords[0][0], coords[1][0]);
                const minLat = Math.min(coords[0][1], coords[2][1]);
                const maxLat = Math.max(coords[0][1], coords[2][1]);

                for(let i=0; i<dotsToShow; i++) {
                    const lat = minLat + Math.random() * (maxLat - minLat);
                    const lng = minLng + Math.random() * (maxLng - minLng);
                    const intensity = totalPeople > 250 ? 1.0 : 0.8;
                    points.push([lat, lng, intensity]);
                }
            });
            return points;
        };

        const heatPoints = generateLaneBasedPoints();
        const heatLayer = L.heatLayer(heatPoints, {
            radius: 5, blur: 6, minOpacity: 0.6,
            gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' }
        }).addTo(heatMap);

        setInterval(() => {
            const newPoints = generateLaneBasedPoints();
            heatLayer.setLatLngs(newPoints);
            lanesData.forEach(l => {
                let change = Math.floor(Math.random() * 5) - 2;
                if(l.properties.id === 'L02' || l.properties.id === 'L03') {
                      if(l.properties.current < 250) change = 5; 
                }
                l.properties.current += change;
            });
        }, 2000);

        // --- MAP 2: ALERT MAP (Center) ---
        const alertMap = L.map('alertmap-container', { 
            zoomControl: true, 
            layers: [mapStyleNormal] // Default
        }).setView(CENTER_COORDS, 18);

        // Add Layer Control to Alert Map
        const alertMapLayers = {
            "Map View": mapStyleNormal,
            "Satellite": mapStyleSatellite
        };
        L.control.layers(alertMapLayers, null, { position: 'topright' }).addTo(alertMap);

        // --- INTERACTION FUNCTIONS ---

        function renderGuards() {
            const container = document.getElementById('guard-list');
            container.innerHTML = '';
            guards.forEach(g => {
                const color = g.status === 'Available' ? '#10b981' : '#ef4444';
                const div = document.createElement('div');
                div.className = 'guard-card';
                div.id = `guard-card-${g.id}`;
                div.innerHTML = `
                    <div class="guard-header">
                        <span style="font-weight:600; color:var(--navy);">${g.name}</span>
                        <span style="font-size:0.75rem; color:${color}; font-weight:600;">
                            <span class="status-dot" style="background:${color}"></span>${g.status}
                        </span>
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-muted); display:flex; justify-content:space-between;">
                        <span>üìç ${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}</span>
                        <span>${g.dist === 'Calculating...' ? '' : g.dist}</span>
                    </div>
                `;
                container.appendChild(div);

                L.circleMarker([g.lat, g.lon], {
                    radius: 5, color: '#012a4a', fillColor: '#012a4a', fillOpacity: 1
                }).addTo(alertMap).bindTooltip(g.name);
            });
        }

        alerts.forEach(a => {
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="pulse-marker">${a.icon}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            const marker = L.marker([a.lat, a.lon], {icon: icon}).addTo(alertMap);
            marker.on('click', () => openAlertPanel(a));
        });

        const laneContainer = document.getElementById('lane-grid');
        for(let i=1; i<=8; i++) {
            const state = (i === 3 || i === 8) ? 'busy' : 'open';
            const div = document.createElement('div');
            div.className = `lane-btn ${state}`;
            div.innerHTML = `<h5>L-${i}</h5><span>${state.toUpperCase()}</span>`;
            div.onclick = function() {
                if(this.classList.contains('open')) {
                    this.className = 'lane-btn busy';
                    this.querySelector('span').innerText = 'BUSY';
                } else if(this.classList.contains('busy')) {
                    this.className = 'lane-btn closed';
                    this.querySelector('span').innerText = 'CLOSED';
                } else {
                    this.className = 'lane-btn open';
                    this.querySelector('span').innerText = 'OPEN';
                }
            };
            laneContainer.appendChild(div);
        }

        function openAlertPanel(alertData) {
            activeAlertId = alertData;
            document.getElementById('alert-title').innerText = alertData.type;
            document.getElementById('alert-loc').innerText = `${alertData.loc} ‚Ä¢ Just now`;
            document.getElementById('alert-desc').innerText = alertData.desc;
            document.getElementById('alert-panel').style.display = 'block';
            
            alertMap.flyTo([alertData.lat, alertData.lon], 21, { 
                animate: true, 
                duration: 1.5 
            });
        }

        function closeAlert() {
            document.getElementById('alert-panel').style.display = 'none';
        }

        function assignNearestGuard() {
            if(!activeAlertId) return;

            let nearest = null;
            let minDist = Infinity;

            guards.forEach(g => {
                if(g.status === 'Available') {
                    const d = Math.sqrt(Math.pow(g.lat - activeAlertId.lat, 2) + Math.pow(g.lon - activeAlertId.lon, 2));
                    if(d < minDist) {
                        minDist = d;
                        nearest = g;
                    }
                }
            });

            if(nearest) {
                const btn = document.querySelector('.btn-assign');
                btn.innerHTML = `‚úÖ Assigned to ${nearest.name} (ETA: 2m)`;
                btn.style.background = 'var(--green)';

                const path = [[nearest.lat, nearest.lon], [activeAlertId.lat, activeAlertId.lon]];
                L.polyline(path, {color: 'var(--navy)', dashArray: '5, 10', weight: 3}).addTo(alertMap);

                document.querySelectorAll('.guard-card').forEach(el => el.classList.remove('highlight'));
                document.getElementById(`guard-card-${nearest.id}`).classList.add('highlight');

                const toast = document.getElementById('toast');
                toast.innerText = `‚úÖ ${nearest.name} dispatched to ${activeAlertId.loc}`;
                toast.style.transform = 'translateX(0)';
                setTimeout(() => toast.style.transform = 'translateX(200%)', 3000);

                nearest.status = 'Busy';
                setTimeout(renderGuards, 1000);
            } else {
                alert("No available guard teams nearby!");
            }
        }

        // --- LOGOUT FUNCTION ADDED ---
        function logout() {
            // Confirm with user
            if(confirm("Are you sure you want to logout?")) {
                // Clear any stored session data
                localStorage.clear();
                sessionStorage.clear();
                // Redirect to landing page
                window.location.href = "landingpage.html";
            }
        }

        renderGuards();

    </script>
</body>
</html>