<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Somnath Mandir Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Laila:wght@700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- LUMINE UI SYSTEM --- */
        :root{
          --saffron-600: #d97706; --navy-900: #012a4a; --sand: #fdfbf7;
          --card-radius: 16px;
          --ui-font-sans: "Poppins", system-ui, sans-serif;
          --ui-font-serif: "Laila", serif;
        }

        body { background-color: var(--sand); font-family: var(--ui-font-sans); color: var(--navy-900); margin: 0; }
        
        /* Glass Header */
        .lumine-header{
          background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
          border-bottom:1px solid rgba(217,119,6,0.1); padding: 0.8rem 1.5rem;
          display:flex; align-items:center; justify-content:space-between;
          position:sticky; top:0; z-index:60;
        }

        /* Sidebar Styling */
        .lumine-sidebar {
            background: white; border-right: 1px solid rgba(0,0,0,0.05);
            height: calc(100vh - 70px); position: fixed; top: 70px; width: 260px;
            padding: 1.5rem 1rem; display: flex; flex-direction: column; gap: 0.35rem; /* Thoda gap kam kiya taaki sab fit ho jaye */
            z-index: 40;
            overflow-y: auto; /* Scrollbar agar height kam ho */
        }
        
        .sidebar-link {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            border-radius: 10px; color: #64748b; font-weight: 500; text-decoration: none; transition: all 0.2s;
            font-size: 0.95rem;
        }
        .sidebar-link:hover { background-color: #fff7ed; color: var(--saffron-600); }
        .sidebar-link.active { background-color: var(--navy-900); color: white; box-shadow: 0 4px 12px rgba(1, 42, 74, 0.15); }
        
        /* SOS Special Style */
        .sidebar-link.sos-link { color: #dc2626; }
        .sidebar-link.sos-link:hover { background-color: #fef2f2; color: #b91c1c; }

        /* Helpers */
        .lumine-card{ background:white; border-radius:var(--card-radius); box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); padding:1.5rem; border:1px solid rgba(2,6,23,0.03); }
        .btn { display:inline-flex; gap:0.5rem; align-items:center; justify-content:center; padding:0.6rem 1.2rem; border-radius:10px; font-weight:600; cursor:pointer; border:none; transition: all 0.2s; font-size: 0.9rem;}
        .btn-primary { background:var(--saffron-600); color:white; }
        .btn-primary:hover { background: #b45309; }
        .btn-ghost { background:transparent; color:var(--navy-900); border:1px solid rgba(2,6,23,0.08); }
        .main-content { margin-left: 260px; padding: 2rem; min-height: calc(100vh - 70px); }
        
        /* Mobile */
        @media (max-width: 1024px) {
            .lumine-sidebar { display: none; }
            .main-content { margin-left: 0; padding: 1rem; }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #digitalIdCard, #digitalIdCard * { visibility: visible; }
            #digitalIdCard { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 400px; border: 2px solid #000; }
        }
        
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
    </style>
</head>
<body>

    <header class="lumine-header">
        <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-xl bg-orange-600 flex items-center justify-center text-white text-2xl shadow-lg shadow-orange-200">üïâÔ∏è</div>
            <div>
                <div class="font-serif font-bold text-navy-900 text-lg leading-none">LUMINE</div>
                <div class="text-[10px] text-orange-700 font-bold tracking-widest uppercase">Devotee Services</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
                <div class="w-9 h-9 rounded-full bg-navy-900 text-white flex items-center justify-center font-bold text-sm" id="userInitial">D</div>
                <div class="hidden md:block">
                    <div class="text-xs text-gray-500 font-medium">Welcome</div>
                    <div class="text-sm font-bold text-navy-900 leading-none" id="headerUserName">Devotee</div>
                </div>
            </div>
        </div>
    </header>

    <aside class="lumine-sidebar">
        <a href="#" class="sidebar-link active">
            <i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard
        </a>
        
        <a href="./bookingslot.html" class="sidebar-link">
            <i data-lucide="calendar-plus" class="w-5 h-5"></i> Slot Booking
        </a>
        
        <a href="myvisit.html" class="sidebar-link">
            <i data-lucide="history" class="w-5 h-5"></i> My Visits
        </a>
        
        <a href="#" class="sidebar-link">
            <i data-lucide="signal" class="w-5 h-5"></i> Lane Status
        </a>

        <div class="my-2 border-t border-gray-100"></div> 
        
        <a href="#" class="sidebar-link">
            <i data-lucide="bell" class="w-5 h-5"></i> Admin Notices
        </a>
        
        <a href="#" class="sidebar-link">
            <i data-lucide="qr-code" class="w-5 h-5"></i> Devotee QR ID
        </a>
        
        <a href="#" class="sidebar-link sos-link">
            <i data-lucide="alert-circle" class="w-5 h-5"></i> Emergency Help (SOS)
        </a>
        
        <a href="#" class="sidebar-link">
            <i data-lucide="headset" class="w-5 h-5"></i> Support
        </a>

        <div class="mt-auto pt-2">
            <button onclick="logout()" class="w-full sidebar-link text-gray-600 hover:bg-red-50 hover:text-red-600">
                <i data-lucide="log-out" class="w-5 h-5"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main-content">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-2xl font-bold text-navy-900 font-serif">Namaste, <span id="welcomeName">Devotee</span></h1>
                <p class="text-gray-500 text-sm mt-1">Manage your darshan bookings and profile.</p>
            </div>
            <div class="text-right hidden sm:block">
                <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Today</div>
                <div class="text-lg font-bold text-orange-600" id="currentDateDisplay">--</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8 space-y-6">

                <div class="lumine-card relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-orange-100 rounded-full blur-3xl -mr-16 -mt-16 opacity-50"></div>
                    
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <h3 class="text-lg font-bold text-navy-900 flex items-center gap-2">
                            <i data-lucide="calendar-clock" class="text-orange-600 w-5 h-5"></i> Upcoming Darshan
                        </h3>
                        <span id="slotStatusBadge" class="hidden px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full border border-green-200">CONFIRMED</span>
                    </div>

                    <div id="noBookingState" class="text-center py-8 hidden">
                        <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="calendar-x" class="w-8 h-8 text-orange-600 opacity-60"></i>
                        </div>
                        <h4 class="text-md font-semibold text-navy-900">No Active Booking</h4>
                        <p class="text-sm text-gray-500 mb-4">Book a slot to see your details here.</p>
                        <a href="./bookingslot.html" class="btn btn-primary">Book New Slot</a>
                    </div>

                    <div id="bookingFoundState" class="hidden relative z-10">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-sand p-3 rounded-lg border border-orange-100">
                                <div class="text-xs text-gray-400 uppercase mb-1">Date</div>
                                <div id="bookingDate" class="font-bold text-navy-900 text-lg">--</div>
                            </div>
                            <div class="bg-sand p-3 rounded-lg border border-orange-100">
                                <div class="text-xs text-gray-400 uppercase mb-1">Time</div>
                                <div id="bookingTime" class="font-bold text-orange-600 text-lg">--</div>
                            </div>
                            <div class="bg-sand p-3 rounded-lg border border-orange-100">
                                <div class="text-xs text-gray-400 uppercase mb-1">ID</div>
                                <div id="bookingId" class="font-bold text-navy-900 text-lg">--</div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="downloadTicket()" class="btn btn-primary">
                                <i data-lucide="download" class="w-4 h-4"></i> Download Ticket
                            </button>
                            <button onclick="cancelBooking()" class="btn btn-ghost text-red-500 hover:bg-red-50">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <div id="membersCard" class="lumine-card p-0 overflow-hidden hidden">
                    <div class="p-5 border-b border-gray-100 bg-sand flex justify-between items-center">
                        <h3 class="font-bold text-navy-900 text-sm uppercase tracking-wide">Group Members</h3>
                        <span class="text-xs font-bold text-orange-600" id="totalMembers">0 Person</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-white text-gray-400 font-medium text-xs uppercase border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4">Age</th>
                                    <th class="px-6 py-4">Aadhaar</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody" class="divide-y divide-gray-50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div id="digitalIdCard" class="lumine-card p-0 overflow-hidden border-t-4 border-t-orange-600 hidden">
                    <div class="bg-navy-900 p-4 text-center">
                        <div class="text-white font-bold tracking-widest text-sm uppercase">E-Pass</div>
                        <div class="text-[10px] text-orange-200">Somnath Mandir Trust</div>
                    </div>
                    <div class="p-6 flex flex-col items-center">
                        <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg bg-gray-200 mb-3 flex items-center justify-center">
                             <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <div id="idCardName" class="text-lg font-bold text-navy-900 text-center">--</div>
                        <div class="text-xs text-gray-500 mb-2">Primary Devotee</div>
                        <div id="idCardBookingId" class="text-xs font-mono font-bold text-navy-900 mb-4 bg-gray-100 px-3 py-1 rounded">--</div>
                        
                        <div class="p-2 bg-white border border-gray-200 rounded-lg mb-4">
                            <img id="qrCodeImage" src="" alt="QR" class="w-32 h-32 opacity-90">
                        </div>
                        <div class="text-[10px] text-gray-400">Scan at Gate Entry</div>
                    </div>
                </div>

                <div class="lumine-card">
                    <h3 class="font-bold text-navy-900 mb-4 flex items-center gap-2">
                        <i data-lucide="activity" class="text-orange-600 w-5 h-5"></i> Live Status
                    </h3>
                    <div class="p-3 rounded-xl border border-green-100 bg-green-50/50 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-bold text-navy-900">General Gate</span>
                        </div>
                        <span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded-md">Open</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Set Date
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'short', day: 'numeric', month: 'short'
            });

            loadBookingData();
        });

        function loadBookingData() {
            // 1. READ FROM LOCAL STORAGE
            const savedDataString = localStorage.getItem('lumine_active_booking');

            if (savedDataString) {
                // --- BOOKING FOUND ---
                console.log("Found Booking Data");
                const data = JSON.parse(savedDataString);

                // Show UI
                document.getElementById('bookingFoundState').classList.remove('hidden');
                document.getElementById('membersCard').classList.remove('hidden');
                document.getElementById('digitalIdCard').classList.remove('hidden');
                document.getElementById('slotStatusBadge').classList.remove('hidden');
                document.getElementById('noBookingState').classList.add('hidden');

                // Populate Fields
                document.getElementById('bookingDate').textContent = data.date;
                document.getElementById('bookingTime').textContent = data.time_slot;
                document.getElementById('bookingId').textContent = data.booking_id;

                // ID Card Details
                if(data.members && data.members.length > 0) {
                    const primaryUser = data.members[0].name;
                    document.getElementById('idCardName').textContent = primaryUser;
                    document.getElementById('welcomeName').textContent = primaryUser.split(' ')[0]; // First name
                    document.getElementById('headerUserName').textContent = primaryUser;
                    document.getElementById('userInitial').textContent = primaryUser.charAt(0).toUpperCase();
                    document.getElementById('totalMembers').textContent = data.members.length + " Person(s)";
                }
                
                document.getElementById('idCardBookingId').textContent = data.booking_id;

                // GENERATE QR CODE (Based on Booking ID)
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data.booking_id)}`;
                document.getElementById('qrCodeImage').src = qrUrl;

                // Populate Table
                const tbody = document.getElementById('membersTableBody');
                tbody.innerHTML = ''; 
                data.members.forEach(m => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b border-gray-50";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-navy-900">${m.name}</td>
                        <td class="px-6 py-4 text-gray-500">${m.age}</td>
                        <td class="px-6 py-4 text-gray-500 font-mono text-xs">${m.aadhaar_mask}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">
                                Verified <i data-lucide="check-circle" class="w-3 h-3"></i>
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();

            } else {
                // --- NO BOOKING ---
                console.log("No Data Found");
                document.getElementById('noBookingState').classList.remove('hidden');
                document.getElementById('bookingFoundState').classList.add('hidden');
                document.getElementById('membersCard').classList.add('hidden');
                document.getElementById('digitalIdCard').classList.add('hidden');
                document.getElementById('slotStatusBadge').classList.add('hidden');
                
                // Reset Name
                document.getElementById('welcomeName').textContent = "Devotee";
            }
        }

        // DOWNLOAD TICKET FUNCTION
        function downloadTicket() {
            // Using print as PDF
            window.print();
        }

        // CANCEL BOOKING (Debug/Reset)
        function cancelBooking() {
            if(confirm("Are you sure you want to cancel this booking?")) {
                localStorage.removeItem('lumine_active_booking');
                window.location.reload();
            }
        }

        function logout() {
            // localStorage.clear(); // Optional: Clear all
            window.location.href = 'landingpage.html';
        }
    </script>
</body>
</html>