<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumine Admin - Live Heatmap</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Laila:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lumine: {
                            navy: '#001f3f',       
                            orange: '#e86c00',     
                            saffron: '#F97316',    
                            bg: '#F8F9FA'          
                        },
                        density: {
                            low: '#10B981',    
                            mid: '#FBBF24',    
                            high: '#F97316',   
                            critical: '#EF4444' 
                        }
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        serif: ['Laila', 'serif'],
                    },
                    boxShadow: {
                        'card': '0 2px 5px rgba(0,0,0,0.05)',
                        'floating': '0 4px 15px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Overrides */
        body { font-family: 'Poppins', sans-serif; background-color: #F8F9FA; }
        
        #map {
            height: calc(100vh - 80px); 
            width: 100%;
            z-index: 10;
        }

        /* Floating Panel Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.1);
        }

        /* Slide over animation */
        .slide-over {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .slide-over.closed {
            transform: translateX(110%);
        }
        .slide-over.open {
            transform: translateX(0);
        }
        
        .nav-border {
            border-bottom: 2px solid #e86c00;
        }

        /* Toast Animation */
        @keyframes slideInBottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideInBottom 0.5s forwards;
        }

        /* Custom Cluster Icon */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background-color: rgba(0, 31, 63, 0.6);
        }
        .marker-cluster div {
            background-color: rgba(0, 31, 63, 0.9);
            color: white;
            font-family: 'Poppins';
            font-weight: bold;
        }

        /* LEAFLET CONTROL CUSTOMIZATION (Layers & Zoom) */
        .leaflet-control-zoom a, .leaflet-control-layers-toggle {
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            color: #001f3f !important;
            border: 1px solid #e2e8f0 !important;
            background: rgba(255, 255, 255, 0.95) !important;
        }
        .leaflet-bar { border: none !important; box-shadow: none !important; }
        .leaflet-touch .leaflet-control-layers, .leaflet-touch .leaflet-bar {
            border: none !important;
        }
        .leaflet-control-layers {
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            border: 1px solid #e2e8f0 !important;
            font-family: 'Poppins', sans-serif !important;
            font-size: 0.8rem !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-lumine-bg text-gray-800 overflow-hidden">

    <nav class="bg-white h-16 flex items-center justify-between px-6 nav-border z-50 relative shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-lumine-orange rounded flex items-center justify-center text-white">
                <i class="fas fa-gopuram text-sm"></i>
            </div>
            <div class="flex flex-col leading-tight">
                <span class="font-bold text-lg text-lumine-navy tracking-wide">Lumine</span>
                <span class="text-[10px] font-bold text-lumine-orange tracking-wider uppercase">SOMNATH MANDIR</span>
            </div>
        </div>

        <div class="flex items-center gap-1">
            <a href="admindashboard.html" class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:text-lumine-orange transition">Dashboard</a>
            <a href="heatmap.html" class="px-5 py-1.5 text-sm font-medium text-white bg-lumine-orange rounded-full shadow-md">Live Heatmap</a>
            <a href="guard.html" class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:text-lumine-orange transition">Guard Teams</a>
            <a href="lane.html" class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:text-lumine-orange transition">Lane Control</a>
            <a href="settings.html" class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:text-lumine-orange transition">Settings</a>
        </div>

        <div class="flex items-center gap-4">
            <div class="w-9 h-9 rounded-full bg-orange-100 text-lumine-orange flex items-center justify-center font-bold text-sm border border-orange-200">
                A
            </div>
        </div>
    </nav>

    <div class="relative w-full h-[calc(100vh-64px)]">
        
        <div class="absolute top-4 left-4 z-[400] w-64 glass-panel rounded-xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-800 text-sm flex items-center gap-2">
                    <i class="fas fa-layer-group text-lumine-orange"></i> View Controls
                </h2>
            </div>
            <div class="p-4 space-y-4">
                <div class="space-y-3">
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-xs font-medium text-gray-600 group-hover:text-lumine-navy">Heatmap Overlay</span>
                        <input type="checkbox" checked id="toggle-heatmap" class="accent-lumine-orange w-4 h-4 cursor-pointer">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-xs font-medium text-gray-600 group-hover:text-lumine-navy">Cameras (52 Active)</span>
                        <input type="checkbox" checked id="toggle-cameras" class="accent-lumine-orange w-4 h-4 cursor-pointer">
                    </label>
                </div>

                <div class="pt-2 border-t border-gray-100">
                    <div class="text-[10px] uppercase font-bold text-gray-400 mb-2">Cluster Density</div>
                    <div class="text-[10px] text-gray-500 mb-2">1 Dot = 20 People</div>
                    <div class="flex justify-between items-center text-[10px] font-medium text-gray-500">
                        <span>Low</span>
                        <div class="h-1.5 w-24 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full mx-2"></div>
                        <span>Critical</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="map" class="w-full h-full bg-gray-100"></div>

        <div id="details-panel" class="absolute top-4 bottom-4 right-4 w-80 glass-panel rounded-xl z-[500] slide-over closed flex flex-col overflow-hidden">
            <div class="p-4 bg-white border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 id="panel-title" class="font-bold text-gray-800 text-lg">Lane Details</h3>
                    <p id="panel-id" class="text-xs text-gray-400 font-mono">Select a lane</p>
                </div>
                <button onclick="ui.closePanel()" class="w-8 h-8 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-5 flex-1 overflow-y-auto bg-gray-50/50">
                <div class="bg-white p-4 rounded-xl shadow-card mb-4 border border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Current Status</span>
                        <span id="panel-status-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700">NORMAL</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="panel-count" class="text-3xl font-bold text-gray-800">0</span>
                        <span class="text-sm text-gray-400">devotees</span>
                    </div>
                    <div id="dashboard-broadcast-msg" class="mt-3 text-[10px] font-mono bg-gray-100 p-2 rounded text-gray-600 border border-gray-200 hidden">
                        <i class="fas fa-rss text-orange-500 mr-1"></i> Broadcasting: <span class="font-bold">LANE OPEN</span>
                    </div>
                    <div class="w-full h-1.5 bg-gray-100 rounded-full mt-3 overflow-hidden">
                        <div id="panel-progress" class="h-full bg-lumine-orange rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-card mb-4 border border-gray-100">
                    <h4 class="text-xs font-semibold text-gray-700 mb-3">Live Trend (30m)</h4>
                    <div class="h-16 w-full flex items-end gap-1" id="sparkline-container">
                        </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-lumine-orange hover:shadow-md transition text-left group">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mb-2 group-hover:bg-blue-500 group-hover:text-white transition">
                            <i class="fas fa-video"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-600 block">View Cam</span>
                    </button>
                    <button class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-lumine-orange hover:shadow-md transition text-left group">
                        <div class="w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center mb-2 group-hover:bg-purple-500 group-hover:text-white transition">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-600 block">Broadcast</span>
                    </button>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-100">
                <button onclick="ui.assignGuard()" class="w-full bg-gray-900 hover:bg-black text-white font-medium py-3 rounded-xl shadow-lg shadow-gray-200 transition flex items-center justify-center gap-2 group">
                    <i class="fas fa-shield-alt group-hover:text-lumine-orange transition"></i> 
                    <span>Deploy Guard Team</span>
                </button>
            </div>
        </div>

        <div id="toast-notification" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-full shadow-2xl z-[600] hidden flex items-center gap-3">
            <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-xs">
                <i class="fas fa-check"></i>
            </div>
            <div class="text-sm font-medium">
                Team Gamma deployed to <span id="toast-lane-name" class="text-lumine-orange font-bold">Lane 1</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        /**
         * SOMNATH MANDIR LIVE HEATMAP
         */

        // 1. Constants (Center on Temple)
        const MAP_CENTER = [20.8881, 70.4012]; 
        const ZOOM_LEVEL = 20;

        // 2. Data Models (Lanes East -> West)
        const generateLaneFeature = (index) => {
            const latBase = 20.8883 - (index * 0.00006); 
            const lngStart = 70.4016; // Gate
            const lngEnd = 70.4008;   // Mandir
            
            return { 
                "type": "Feature", 
                "properties": { 
                    "id": `L0${index + 1}`, 
                    "name": `Queue Lane ${index + 1}`, 
                    "capacity": 300, 
                    "current": 50 + Math.floor(Math.random() * 50) 
                }, 
                "geometry": { 
                    "type": "Polygon", 
                    "coordinates": [[
                        [lngStart, latBase], 
                        [lngEnd, latBase], 
                        [lngEnd, latBase - 0.00004], 
                        [lngStart, latBase - 0.00004], 
                        [lngStart, latBase]
                    ]] 
                } 
            };
        };

        const lanesData = {
            "type": "FeatureCollection",
            "features": Array.from({ length: 8 }, (_, i) => generateLaneFeature(i))
        };
        // Spiking Lane 2 & 3
        lanesData.features[1].properties.current = 280; 
        lanesData.features[2].properties.current = 295;

        // 3. Logic
        const App = {
            map: null,
            layers: { 
                lanes: null, 
                heat: null, 
                cameras: null 
            },
            state: { selectedLaneId: null },

            init() {
                this.initMap();
                this.renderHiddenLanes(); 
                this.renderHeatmap();
                this.renderCameras();
                this.setupControls(); // Separate controls setup
                this.startSimulation();
            },

            initMap() {
                // Define Tile Layers
                const mapStyleNormal = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
                    attribution: 'Lumine', maxZoom: 21 
                });
                const mapStyleSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri', maxZoom: 21 
                });

                // Init Map
                this.map = L.map('map', {
                    center: MAP_CENTER,
                    zoom: ZOOM_LEVEL,
                    zoomControl: false, 
                    attributionControl: false,
                    layers: [mapStyleNormal], // Default Layer
                    maxBounds: [[20.8870, 70.4000], [20.8890, 70.4030]],
                    maxBoundsViscosity: 1.0
                });

                // Add Controls
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                
                // Layer Switcher
                const baseMaps = {
                    "Map View": mapStyleNormal,
                    "Satellite": mapStyleSatellite
                };
                L.control.layers(baseMaps, null, { position: 'topright' }).addTo(this.map);
            },

            renderHiddenLanes() {
                if (this.layers.lanes) this.map.removeLayer(this.layers.lanes);
                this.layers.lanes = L.geoJSON(lanesData, {
                    style: { stroke: false, fill: false, opacity: 0, fillOpacity: 0 },
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => this.selectLane(feature.properties));
                    }
                }).addTo(this.map);
            },

            renderHeatmap() {
                const heatPoints = this.generateLaneBasedPoints();
                this.layers.heat = L.heatLayer(heatPoints, {
                    radius: 5, blur: 6, minOpacity: 0.6,
                    gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' }
                });
                // Add by default
                this.map.addLayer(this.layers.heat);
            },

            renderCameras() {
                // Generate MANY mock cameras along the path
                const cameraMarkers = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true,
                    maxClusterRadius: 30
                });

                const icon = L.divIcon({
                    className: 'custom-cam',
                    html: `<div class="w-5 h-5 bg-gray-900 rounded-full text-white flex items-center justify-center text-[8px] shadow-sm border border-white"><i class="fas fa-video"></i></div>`,
                    iconSize: [20, 20]
                });

                // Create ~50 cameras along the lanes
                for(let i=0; i<52; i++) {
                    // Random lane
                    const laneIdx = i % 8;
                    const lane = lanesData.features[laneIdx];
                    const coords = lane.geometry.coordinates[0];
                    // Interpolate along lane
                    const t = Math.random(); // 0 to 1 along path
                    const lng = coords[0][0] + (coords[1][0] - coords[0][0]) * t;
                    const lat = coords[0][1] + (coords[3][1] - coords[0][1]) * Math.random();

                    const marker = L.marker([lat, lng], { icon: icon })
                        .bindPopup(`<b>Camera CAM-${1000+i}</b><br>Status: Online<br>Count: ${Math.floor(Math.random()*40)}`);
                    cameraMarkers.addLayer(marker);
                }

                this.layers.cameras = cameraMarkers;
                this.map.addLayer(this.layers.cameras);
            },

            setupControls() {
                // Robust Event Listeners
                const heatToggle = document.getElementById('toggle-heatmap');
                const camToggle = document.getElementById('toggle-cameras');

                heatToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!this.map.hasLayer(this.layers.heat)) {
                            this.map.addLayer(this.layers.heat);
                        }
                    } else {
                        if (this.map.hasLayer(this.layers.heat)) {
                            this.map.removeLayer(this.layers.heat);
                        }
                    }
                });

                camToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!this.map.hasLayer(this.layers.cameras)) {
                            this.map.addLayer(this.layers.cameras);
                        }
                    } else {
                        if (this.map.hasLayer(this.layers.cameras)) {
                            this.map.removeLayer(this.layers.cameras);
                        }
                    }
                });
            },

            generateLaneBasedPoints() {
                const points = [];
                const AGGREGATION_FACTOR = 20; 
                lanesData.features.forEach(lane => {
                    const totalPeople = lane.properties.current;
                    const dotsToShow = Math.ceil(totalPeople / AGGREGATION_FACTOR);
                    const coords = lane.geometry.coordinates[0];
                    const minLng = Math.min(coords[0][0], coords[1][0]);
                    const maxLng = Math.max(coords[0][0], coords[1][0]);
                    const minLat = Math.min(coords[0][1], coords[2][1]);
                    const maxLat = Math.max(coords[0][1], coords[2][1]);

                    for(let i=0; i<dotsToShow; i++) {
                        const lat = minLat + Math.random() * (maxLat - minLat);
                        const lng = minLng + Math.random() * (maxLng - minLng);
                        const intensity = totalPeople > 250 ? 1.0 : 0.8;
                        points.push([lat, lng, intensity]);
                    }
                });
                return points;
            },

            selectLane(props) {
                this.state.selectedLaneId = props.id;
                ui.openPanel(props);
            },

            startSimulation() {
                setInterval(() => {
                    if(this.layers.heat) {
                        const newPoints = this.generateLaneBasedPoints();
                        this.layers.heat.setLatLngs(newPoints);
                    }
                    if (this.state.selectedLaneId) {
                        const lane = lanesData.features.find(f => f.properties.id === this.state.selectedLaneId);
                        if(lane) {
                            let change = Math.floor(Math.random() * 5) - 2;
                            if(lane.properties.id === 'L02' || lane.properties.id === 'L03') {
                                if(lane.properties.current < 250) change = 5; 
                            }
                            lane.properties.current += change;
                            ui.updateMetrics(lane.properties.current, lane.properties.capacity);
                        }
                    }
                }, 2000);
            }
        };

        const ui = {
            panel: document.getElementById('details-panel'),
            openPanel(data) {
                this.panel.classList.remove('closed');
                this.panel.classList.add('open');
                document.getElementById('panel-title').innerText = data.name;
                document.getElementById('panel-id').innerText = `ID: #${data.id}`;
                this.updateMetrics(data.current, data.capacity);
                this.generateSparklines();
            },
            updateMetrics(current, capacity = 300) {
                document.getElementById('panel-count').innerText = current;
                const pct = Math.min((current / capacity) * 100, 100);
                document.getElementById('panel-progress').style.width = `${pct}%`;
                
                const statusEl = document.getElementById('panel-status-badge');
                const broadcastEl = document.getElementById('dashboard-broadcast-msg');

                if (pct > 90) {
                    statusEl.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700";
                    statusEl.innerText = "FULL / CRITICAL";
                    broadcastEl.classList.remove('hidden');
                    broadcastEl.innerHTML = `<i class="fas fa-broadcast-tower text-red-500 mr-1 animate-pulse"></i> App Status: <span class="font-bold text-red-700">CLOSED / FULL</span>`;
                } else if (pct > 60) {
                    statusEl.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-700";
                    statusEl.innerText = "HEAVY TRAFFIC";
                    broadcastEl.classList.remove('hidden');
                    broadcastEl.innerHTML = `<i class="fas fa-broadcast-tower text-orange-500 mr-1"></i> App Status: <span class="font-bold text-orange-700">WAIT TIME 15m</span>`;
                } else {
                    statusEl.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700";
                    statusEl.innerText = "NORMAL";
                    broadcastEl.classList.add('hidden');
                }
            },
            closePanel() {
                this.panel.classList.remove('open');
                this.panel.classList.add('closed');
                App.state.selectedLaneId = null;
            },
            generateSparklines() {
                const container = document.getElementById('sparkline-container');
                container.innerHTML = '';
                for(let i=0; i<25; i++) {
                    const h = Math.floor(Math.random() * 100);
                    const bar = document.createElement('div');
                    bar.style.height = `${h}%`;
                    bar.className = 'flex-1 bg-orange-100 rounded-sm hover:bg-lumine-orange transition-colors';
                    container.appendChild(bar);
                }
            },
            assignGuard() {
                const btn = document.querySelector('#details-panel button.w-full');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Dispatching...`;
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    ui.closePanel();
                    const toast = document.getElementById('toast-notification');
                    toast.classList.remove('hidden');
                    toast.classList.add('toast-enter');
                    setTimeout(() => toast.classList.add('hidden'), 4000);
                }, 1500);
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>